# Կառուցեք ձեր սեփական SMTP նամակների ուղարկման սերվերը

## նախաբան

SMTP-ն կարող է ուղղակիորեն ծառայություններ գնել ամպային վաճառողներից, ինչպիսիք են՝

* [Amazon SES SMTP](https://docs.aws.amazon.com/ses/latest/dg/send-email-smtp.html)
* [Ալի ամպային էլփոստի հրում](https://www.alibabacloud.com/help/directmail/latest/three-mail-sending-methods)

Դուք կարող եք նաև ստեղծել ձեր սեփական փոստի սերվերը՝ անսահմանափակ ուղարկում, ցածր ընդհանուր արժեք:

Ստորև մենք քայլ առ քայլ ցույց ենք տալիս, թե ինչպես կառուցել մեր սեփական փոստային սերվերը:

## Սերվերի ընտրություն

Ինքնահոսթինգային SMTP սերվերը պահանջում է հանրային IP՝ 25, 456 և 587 բաց նավահանգիստներով:

Սովորաբար օգտագործվող հանրային ամպերը լռելյայն արգելափակել են այս նավահանգիստները, և հնարավոր է, որ դրանք բացվեն աշխատանքային պատվեր տալով, բայց ի վերջո դա շատ անհանգիստ է:

Ես խորհուրդ եմ տալիս գնել այն հոսթից, որն ունի այս նավահանգիստները բաց և աջակցում է հակադարձ տիրույթի անունների տեղադրմանը:

Այստեղ ես խորհուրդ եմ տալիս [Contabo-ին](https://contabo.com) :

Contabo-ն հոսթինգ մատակարար է, որը հիմնված է Գերմանիայի Մյունխեն քաղաքում, որը հիմնադրվել է 2003 թվականին՝ շատ մրցունակ գներով:

Եթե ​​որպես գնման արժույթ ընտրեք եվրոն, գինն ավելի էժան կլինի (8 ԳԲ հիշողությամբ և 4 պրոցեսորով սերվերն արժե տարեկան մոտ 529 յուան, իսկ տեղադրման սկզբնական վճարը մեկ տարի անվճար է):

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/UoAQkwY.webp)

Պատվեր կատարելիս նշեք `prefer AMD` , և AMD պրոցեսորով սերվերը կունենա ավելի լավ կատարում:

Հետևյալում ես կվերցնեմ Contabo-ի VPS-ը որպես օրինակ՝ ցույց տալու համար, թե ինչպես կառուցել ձեր սեփական փոստային սերվերը:

## Ubuntu համակարգի կոնֆիգուրացիա

Այստեղ օպերացիոն համակարգը Ubuntu 22.04-ն է

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/smpIu1F.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/m7Mwjwr.webp)

Եթե ​​ssh սերվերը ցուցադրում է `Welcome to TinyCore 13!` (ինչպես ցույց է տրված ստորև նկարում), դա նշանակում է, որ համակարգը դեռ տեղադրված չէ: Խնդրում ենք անջատել ssh-ը և սպասել մի քանի րոպե՝ նորից մուտք գործելու համար:

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/-qKACz9.webp)

Երբ հայտնվի `Welcome to Ubuntu 22.04.1 LTS` , սկզբնավորումն ավարտված է, և դուք կարող եք շարունակել հետևյալ քայլերը:

### [Ըստ ցանկության] Նախաձեռնել զարգացման միջավայրը

Այս քայլը պարտադիր չէ:

Հարմարության համար ես տեղադրել եմ ubuntu ծրագրաշարի տեղադրումը և համակարգի կազմաձևումը [github.com/wactax/ops.os/tree/main/ubuntu-](https://github.com/wactax/ops.os/tree/main/ubuntu) ում:

Մեկ սեղմումով տեղադրելու համար գործարկեք հետևյալ հրամանը.

```
bash <(curl -s https://raw.githubusercontent.com/wactax/ops.os/main/ubuntu/boot.sh)
```

Չինացի օգտատերեր, փոխարենը օգտագործեք հետևյալ հրամանը, և լեզուն, ժամային գոտին և այլն ավտոմատ կերպով կկարգավորվեն:

```
CN=1 bash <(curl -s https://ghproxy.com/https://raw.githubusercontent.com/wactax/ops.os/main/ubuntu/boot.sh)
```

### Contabo-ն միացնում է IPV6-ը

Միացրեք IPV6-ը, որպեսզի SMTP-ն կարողանա նաև նամակներ ուղարկել IPV6 հասցեներով:

խմբագրել `/etc/sysctl.conf`

Փոփոխեք կամ ավելացրեք հետևյալ տողերը

```
net.ipv6.conf.all.disable_ipv6 = 0
net.ipv6.conf.default.disable_ipv6 = 0
net.ipv6.conf.lo.disable_ipv6 = 0
```

Հետևեք [contabo ձեռնարկին. IPv6 կապի ավելացում ձեր սերվերին](https://contabo.com/blog/adding-ipv6-connectivity-to-your-server/)

Խմբագրեք `/etc/netplan/01-netcfg.yaml` , ավելացրեք մի քանի տող, ինչպես ցույց է տրված ստորև նկարում (Contabo VPS լռելյայն կազմաձևման ֆայլն արդեն ունի այս տողերը, պարզապես հանեք դրանք մեկնաբանությունից):

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/5MEi41I.webp)

Այնուհետև `netplan apply` , որպեսզի փոփոխված կոնֆիգուրացիան ուժի մեջ մտնի:

Կարգավորումը հաջողությամբ ավարտվելուց հետո կարող եք օգտագործել `curl 6.ipw.cn` ՝ ձեր արտաքին ցանցի ipv6 հասցեն դիտելու համար:

## Կլոնավորեք կազմաձևման պահոցը

```
git clone https://github.com/wactax/ops.soft.git
```

## Ստեղծեք անվճար SSL վկայագիր ձեր տիրույթի անվան համար

Փոստ ուղարկելու համար անհրաժեշտ է SSL վկայագիր կոդավորման և ստորագրման համար:

Մենք օգտագործում ենք [acme.sh](https://github.com/acmesh-official/acme.sh) վկայականներ ստեղծելու համար:

acme.sh-ը բաց կոդով ավտոմատացված վկայականի ստորագրման գործիք է,

Մուտքագրեք կոնֆիգուրացիայի պահեստը ops.soft, գործարկեք `./ssl.sh` , և **վերին գրացուցակում** կստեղծվի `conf` թղթապանակ:

Գտեք ձեր DNS մատակարարին [acme.sh dnsapi-](https://github.com/acmesh-official/acme.sh/wiki/dnsapi) ից, խմբագրեք `conf/conf.sh` :

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/Qjq1C1i.webp)

Այնուհետև գործարկեք `./ssl.sh 123.com` ՝ ձեր տիրույթի անվան համար `123.com` և `*.123.com` վկայագրեր ստեղծելու համար:

Առաջին գործարկումն ավտոմատ կերպով կտեղադրի [acme.sh-ը](https://github.com/acmesh-official/acme.sh) և կավելացնի պլանավորված առաջադրանք՝ ավտոմատ նորացման համար: Դուք կարող եք տեսնել `crontab -l` , կա այսպիսի տող հետևյալ կերպ.

```
52 0 * * * "/mnt/www/.acme.sh"/acme.sh --cron --home "/mnt/www/.acme.sh" > /dev/null
```

Ստեղծված վկայագրի ուղին նման է `/mnt/www/.acme.sh/123.com_ecc。`

Վկայագրի նորացումը կկանչի `conf/reload/123.com.sh` սկրիպտը, խմբագրեք այս սկրիպտը, կարող եք ավելացնել հրամաններ, ինչպիսին է `nginx -s reload` ՝ հարակից հավելվածների վկայականի քեշը թարմացնելու համար:

## Կառուցեք SMTP սերվեր chasquid-ով

[chasquid-ը](https://github.com/albertito/chasquid) բաց կոդով SMTP սերվեր է՝ գրված Go լեզվով:

Որպես փոխարինող հին փոստի սերվերի ծրագրերին, ինչպիսիք են Postfix-ը և Sendmail-ը, chasquid-ն ավելի պարզ և հեշտ է օգտագործել, ինչպես նաև ավելի հեշտ է երկրորդական զարգացման համար:

Run `./chasquid/init.sh 123.com` ավտոմատ կերպով կտեղադրվի մեկ սեղմումով (փոխարինեք 123.com-ը ձեր ուղարկող տիրույթի անունով):

## Կարգավորեք էլփոստի ստորագրությունը DKIM

DKIM-ն օգտագործվում է էլ.փոստի ստորագրություններ ուղարկելու համար՝ կանխելու նամակները որպես սպամ չվերաբերվել:

Հրամանի հաջող գործարկումից հետո ձեզ կառաջարկվի սահմանել DKIM ռեկորդը (ինչպես ցույց է տրված ստորև):

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/LJWGsmI.webp)

Պարզապես ավելացրեք TXT գրառում ձեր DNS-ին (ինչպես ցույց է տրված ստորև):

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/0szKWqV.webp)

## Դիտեք ծառայության կարգավիճակը և տեղեկամատյանները

 `systemctl status chasquid` Դիտել ծառայության կարգավիճակը:

Նորմալ շահագործման վիճակը նման է ստորև նկարում

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/CAwyY4E.webp)

 `grep chasquid /var/log/syslog` կամ `journalctl -xeu chasquid` կարող է դիտել սխալների գրանցամատյանը:

## Հակադարձ տիրույթի անվան կազմաձևում

Հակադարձ տիրույթի անունը թույլ է տալիս IP հասցեն լուծել համապատասխան տիրույթի անունով:

Հակադարձ տիրույթի անուն սահմանելը կարող է կանխել էլ. նամակները որպես սպամ նույնացնելը:

Երբ նամակը ստացվի, ստացող սերվերը կկատարի հակադարձ տիրույթի անվան վերլուծություն ուղարկող սերվերի IP հասցեի վրա՝ հաստատելու, թե արդյոք ուղարկող սերվերն ունի վավեր հակադարձ տիրույթի անուն:

Եթե ​​ուղարկող սերվերը չունի հակադարձ տիրույթի անուն կամ եթե հակառակ տիրույթի անունը չի համընկնում ուղարկող սերվերի IP հասցեի հետ, ստացող սերվերը կարող է էլփոստը ճանաչել որպես սպամ կամ մերժել այն:

Այցելեք [https://my.contabo.com/rdns](https://my.contabo.com/rdns) և կազմաձևեք, ինչպես ցույց է տրված ստորև

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/IIPdBk_.webp)

Հակադարձ տիրույթի անունը սահմանելուց հետո հիշեք, որ ipv4 և ipv6 տիրույթի անվան առաջ լուծումը կարգավորեք սերվերին:

## Խմբագրել chasquid.conf-ի հոսթի անունը

Փոփոխեք `conf/chasquid/chasquid.conf` հակառակ տիրույթի անվան արժեքին:

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/6Fw4SQi.webp)

Այնուհետև գործարկեք `systemctl restart chasquid` ծառայությունը վերագործարկելու համար:

## Կրկնօրինակեք conf-ը git պահոցում

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/Fier9uv.webp)

Օրինակ, ես կրկնօրինակում եմ conf թղթապանակը իմ սեփական github գործընթացում հետևյալ կերպ

Նախ ստեղծեք մասնավոր պահեստ

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/ZSCT1t1.webp)

Մուտքագրեք conf գրացուցակը և ներկայացրեք պահեստ

```
git init
git add .
git commit -m "init"
git branch -M main
git remote add origin git@github.com:wac-tax-key/conf.git
git push -u origin main
```

## Ավելացնել ուղարկող

վազել

```
chasquid-util user-add i@wac.tax
```

Կարող է ավելացնել ուղարկող

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/khHjLof.webp)

### Ստուգեք, որ գաղտնաբառը ճիշտ է դրված

```
chasquid-util authenticate i@wac.tax --password=xxxxxxx
```

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/e92JHXq.webp)

Օգտատիրոջը ավելացնելուց հետո `chasquid/domains/wac.tax/users` կթարմացվի, հիշեք, որ այն ներկայացրեք պահեստ:

## DNS-ն ավելացնում է SPF գրառումը

SPF (Sender Policy Framework) էլփոստի ստուգման տեխնոլոգիա է, որն օգտագործվում է էլփոստի խարդախությունը կանխելու համար:

Այն ստուգում է փոստ ուղարկողի ինքնությունը՝ ստուգելով, որ ուղարկողի IP հասցեն համընկնում է տիրույթի անվանման DNS գրառումների հետ, որը նա պնդում է, որ խարդախներին թույլ չի տալիս կեղծ նամակներ ուղարկել:

SPF գրառումների ավելացումը կարող է հնարավորինս կանխել էլ. փոստերը որպես սպամ ճանաչվելը:

Եթե ​​ձեր տիրույթի անվան սերվերը չի աջակցում SPF տիպին, պարզապես ավելացրեք TXT տեսակի գրառումը:

Օրինակ, `wac.tax` ի SPF-ն հետևյալն է

`v=spf1 a mx include:_spf.wac.tax include:_spf.google.com ~all`

SPF `_spf.wac.tax` ի համար

`v=spf1 a:smtp.wac.tax ~all`

Նկատի ունեցեք, որ ես այստեղ `include:_spf.google.com` , դա պայմանավորված է նրանով, որ ես հետագայում կկազմաձևեմ `i@wac.tax` որպես ուղարկող հասցե Google փոստարկղում:

## DNS կոնֆիգուրացիա DMARC

DMARC-ը (Domain-based Message Authentication, Reporting & Conformance)-ի հապավումն է:

Այն օգտագործվում է SPF-ի ցատկումները գրավելու համար (կարող է պայմանավորված լինել կազմաձևման սխալներով, կամ ինչ-որ մեկը ձևացնում է, որ դուք եք սպամ ուղարկելու համար):

Ավելացնել TXT գրառում `_dmarc` ,

Բովանդակությունը հետեւյալն է

```
v=DMARC1; p=quarantine; fo=1; ruf=mailto:ruf@wac.tax; rua=mailto:rua@wac.tax
```

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/k44P7O3.webp)

Յուրաքանչյուր պարամետրի իմաստը հետևյալն է

### p (Քաղաքականություն)

Ցույց է տալիս, թե ինչպես վարվել նամակների հետ, որոնք ձախողվում են SPF (Sender Policy Framework) կամ DKIM (DomainKeys Identified Mail) ստուգում: p պարամետրը կարող է սահմանվել երեք արժեքներից մեկի վրա.

* Ոչ մեկը. Ոչ մի գործողություն չի ձեռնարկվում, միայն ստուգման արդյունքը հետ է ուղարկվում ուղարկողին էլփոստի հաշվետվության մեխանիզմի միջոցով:
* Կարանտին. Տեղադրեք այն նամակը, որը ստուգումը չի անցել սպամի թղթապանակում, բայց ուղղակիորեն չի մերժի նամակը:
* մերժել. ուղղակիորեն մերժել նամակները, որոնք չեն հաստատում:

### fo (Ձախողման ընտրանքներ)

Նշում է հաշվետվության մեխանիզմով վերադարձվող տեղեկատվության քանակը: Այն կարող է սահմանվել հետևյալ արժեքներից մեկի վրա.

* 0: Հաղորդեք վավերացման արդյունքների մասին բոլոր հաղորդագրությունների համար
* 1. Հաղորդել միայն այն հաղորդագրությունների մասին, որոնք չեն հաստատում
* դ․ զեկուցել միայն տիրույթի անվան ստուգման ձախողումների մասին
* s. զեկուցել միայն SPF-ի ստուգման ձախողումների մասին
* l. Հաղորդել միայն DKIM-ի ստուգման ձախողումների մասին

### rua & ruf

* rua (Հաշվետվական URI համախառն հաշվետվությունների համար). Էլ. հասցե՝ համախառն հաշվետվություններ ստանալու համար
* ruf (Զեկուցող URI դատաբժշկական հաշվետվությունների համար). էլփոստի հասցե՝ մանրամասն հաշվետվություններ ստանալու համար

## Ավելացրեք MX գրառումներ՝ նամակները Google Mail-ին փոխանցելու համար

Քանի որ ես չկարողացա գտնել անվճար կորպորատիվ փոստարկղ, որն աջակցում է ունիվերսալ հասցեներ (Catch-All, կարող է ստանալ ցանկացած նամակներ, որոնք ուղարկվում են այս տիրույթի անունով, առանց նախածանցների սահմանափակումների), ես օգտագործեցի chasquid՝ բոլոր նամակները Gmail-ի փոստարկղ փոխանցելու համար:

**Եթե ​​ունեք ձեր սեփական վճարովի բիզնես փոստարկղը, խնդրում ենք մի փոփոխեք MX-ը և բաց թողեք այս քայլը:**

Խմբագրել `conf/chasquid/domains/wac.tax/aliases` , սահմանել վերահասցեավորման փոստարկղը

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/OBDl2gw.webp)

`*` ցույց է տալիս բոլոր նամակները, `i` ուղարկող օգտատիրոջ էլփոստի հասցեի նախածանցն է, որը ստեղծվել է վերևում: Փոստ փոխանցելու համար յուրաքանչյուր օգտվող պետք է ավելացնի տող:

Այնուհետև ավելացրեք MX գրառումը (ես ուղղակիորեն ցույց եմ տալիս այստեղ հակառակ դոմենի անվան հասցեն, ինչպես ցույց է տրված ստորև նկարի առաջին տողում):

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/7__KrU8.webp)

Կազմաձևման ավարտից հետո դուք կարող եք օգտագործել այլ էլ․ հասցեներ՝ նամակներ ուղարկելու համար `i@wac.tax` և `any123@wac.tax` ՝ տեսնելու, թե արդյոք կարող եք նամակներ ստանալ Gmail-ում:

Եթե ​​ոչ, ստուգեք chasquid log-ը ( `grep chasquid /var/log/syslog` ):

## Նամակ ուղարկեք i@wac.tax հասցեին՝ Google Mail-ով

Այն բանից հետո, երբ Google Mail-ը ստացավ նամակը, ես, բնականաբար, հույս ունեի i.wac.tax@gmail.com-ի փոխարեն պատասխանել `i@wac.tax` ով:

Այցելեք [https://mail.google.com/mail/u/1/#settings/accounts](https://mail.google.com/mail/u/1/#settings/accounts) և սեղմեք «Ավելացնել այլ էլ․ հասցե»:

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/PAvyE3C.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/_OgLsPT.webp)

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/XIUf6Dc.webp)

Այնուհետև մուտքագրեք հաստատման կոդը, որը ստացվել է նամակով, որին ուղարկվել է:

Ի վերջո, այն կարող է սահմանվել որպես լռելյայն ուղարկողի հասցե (նույն հասցեով պատասխանելու հնարավորության հետ միասին):

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/a95dO60.webp)

Այս կերպ մենք ավարտել ենք SMTP փոստի սերվերի ստեղծումը և միևնույն ժամանակ օգտագործում ենք Google Mail նամակներ ուղարկելու և ստանալու համար:

## Ուղարկեք փորձնական նամակ՝ ստուգելու, թե արդյոք կազմաձևումը հաջող է

Մուտքագրեք `ops/chasquid`

Գործարկել `direnv allow` տեղադրել կախվածություններ (direnv-ը տեղադրվել է նախորդ մեկ բանալի սկզբնավորման գործընթացում և կեռիկ է ավելացվել պատյանում)

ապա վազիր

```
user=i@wac.tax pass=xxxx to=iuser.link@gmail.com ./sendmail.coffee
```

Պարամետրերի իմաստը հետևյալն է

* օգտվող՝ SMTP օգտվողի անուն
* անցում. SMTP գաղտնաբառ
* հասցեատիրոջը

Դուք կարող եք ուղարկել փորձնական նամակ:

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/ae1iWyM.webp)

Խորհուրդ է տրվում օգտագործել Gmail-ը՝ թեստային նամակներ ստանալու համար՝ ստուգելու, թե արդյոք կազմաձևերը հաջող են:

### TLS ստանդարտ գաղտնագրում

Ինչպես ցույց է տրված ստորև նկարում, կա այս փոքրիկ կողպեքը, ինչը նշանակում է, որ SSL վկայագիրը հաջողությամբ միացված է:

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/SrdbAwh.webp)

Այնուհետև կտտացրեք «Ցույց տալ բնօրինակ էլ.փոստը»

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/qQQsdxg.webp)

### DKIM

Ինչպես ցույց է տրված ստորև նկարում, Gmail-ի սկզբնական փոստի էջը ցուցադրում է DKIM, ինչը նշանակում է, որ DKIM կոնֆիգուրացիան հաջող է:

![](https://pub-b8db533c86124200a9d799bf3ba88099.r2.dev/2023/03/an6aXK6.webp)

Ստուգեք Received-ը սկզբնական էլ.փոստի վերնագրում և կարող եք տեսնել, որ ուղարկողի հասցեն IPV6 է, ինչը նշանակում է, որ IPV6-ը նույնպես հաջողությամբ կազմաձևված է:
